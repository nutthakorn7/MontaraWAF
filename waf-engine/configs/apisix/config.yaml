# APISIX Configuration for WAF Blocking Mode
# config.yaml for APISIX

apisix:
  node_listen: 9080
  enable_ipv6: false
  
  # Enable admin API
  admin_key:
    - name: "admin"
      key: "${APISIX_ADMIN_KEY:-montara-admin-key}"
      role: admin

  # SSL settings
  ssl:
    enable: true
    listen_port: 9443
    ssl_protocols: "TLSv1.2 TLSv1.3"
    ssl_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"

# Enable plugins
plugins:
  - real-ip
  - limit-req
  - limit-count
  - limit-conn
  - request-validation
  - proxy-rewrite
  - prometheus
  - request-id
  - response-rewrite
  - serverless-pre-function
  - serverless-post-function
  - consumer-restriction
  - ip-restriction
  - ua-restriction
  # Custom WAF plugins
  - ext-plugin-pre-req

# Plugin attributes
plugin_attr:
  prometheus:
    export_uri: /apisix/prometheus/metrics
    export_addr:
      ip: "0.0.0.0"
      port: 9091
  
  # External plugin for Coraza WAF
  ext-plugin:
    cmd:
      - "/usr/local/apisix/coraza-runner"
    conf_file: "/usr/local/apisix/conf/coraza/coraza.conf"

# etcd - using standalone mode for demo
deployment:
  role: data_plane
  role_data_plane:
    config_provider: yaml

# Discovery
discovery: {}

# Admin API
admin_api:
  listen_port: 9180
  admin_key:
    - name: "admin"
      key: "${APISIX_ADMIN_KEY:-montara-admin-key}"
      role: admin
