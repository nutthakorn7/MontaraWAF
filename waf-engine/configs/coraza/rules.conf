# Coraza WAF Rules Configuration
# Based on OWASP Core Rule Set (CRS)

# Basic Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial

# Default actions
SecDefaultAction "phase:1,log,auditlog,deny,status:403"
SecDefaultAction "phase:2,log,auditlog,deny,status:403"

# ======================
# SQL Injection Rules
# ======================
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|XML:/* "@detectSQLi" \
    "id:1001,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

# ======================
# XSS Rules
# ======================
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|XML:/* "@detectXSS" \
    "id:1002,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    severity:'CRITICAL'"

# ======================
# Path Traversal Rules
# ======================
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:\.\.[\\/]|\.\.%2[fF]|\.\.%5[cC])" \
    "id:1003,\
    phase:2,\
    block,\
    msg:'Path Traversal Attack Detected',\
    tag:'attack-lfi',\
    severity:'CRITICAL'"

# ======================
# Remote File Inclusion
# ======================
SecRule ARGS "@rx (?i)(?:https?|ftp):\/\/(?!(?:localhost|127\.0\.0\.1))" \
    "id:1004,\
    phase:2,\
    block,\
    msg:'Remote File Inclusion Attack',\
    tag:'attack-rfi',\
    severity:'HIGH'"

# ======================
# Command Injection
# ======================
SecRule ARGS|ARGS_NAMES "@rx (?:;|\||`|\$\(|&&|\|\|)" \
    "id:1005,\
    phase:2,\
    block,\
    msg:'Command Injection Attack',\
    tag:'attack-rce',\
    severity:'CRITICAL'"

# ======================
# Bad User Agents
# ======================
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(?:sqlmap|nikto|nmap|masscan|zgrab|python-requests)" \
    "id:1006,\
    phase:1,\
    block,\
    msg:'Malicious Scanner Detected',\
    tag:'attack-scanner',\
    severity:'HIGH'"

# ======================
# Rate Limiting (backup)
# ======================
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:1007,\
    phase:1,\
    block,\
    msg:'Rate Limit Exceeded',\
    tag:'policy-rate',\
    severity:'MEDIUM'"
